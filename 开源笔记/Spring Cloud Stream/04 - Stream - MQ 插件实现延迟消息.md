![](https://tcs.teambition.net/storage/3122fc789abc920aa324d714c66a06e63942?Signature=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJBcHBJRCI6IjU5Mzc3MGZmODM5NjMyMDAyZTAzNThmMSIsIl9hcHBJZCI6IjU5Mzc3MGZmODM5NjMyMDAyZTAzNThmMSIsIl9vcmdhbml6YXRpb25JZCI6IiIsImV4cCI6MTYxMjc5NTEwNywiaWF0IjoxNjEyMTkwMzA3LCJyZXNvdXJjZSI6Ii9zdG9yYWdlLzMxMjJmYzc4OWFiYzkyMGFhMzI0ZDcxNGM2NmEwNmU2Mzk0MiJ9.DrqwhZTQ_m-QTNHiEYXgcFU21Nwj0FV1LOcORYqUmJI&download=2020-09-17%20061643.png "")



![](https://tcs.teambition.net/storage/31221c5f78a5f5822a7e28919c5a6a28a8ac?Signature=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJBcHBJRCI6IjU5Mzc3MGZmODM5NjMyMDAyZTAzNThmMSIsIl9hcHBJZCI6IjU5Mzc3MGZmODM5NjMyMDAyZTAzNThmMSIsIl9vcmdhbml6YXRpb25JZCI6IiIsImV4cCI6MTYxMjc5NTEwNywiaWF0IjoxNjEyMTkwMzA3LCJyZXNvdXJjZSI6Ii9zdG9yYWdlLzMxMjIxYzVmNzhhNWY1ODIyYTdlMjg5MTljNWE2YTI4YThhYyJ9.P_8hWaz1g2fW_JV1PjZlYKFvs5t9Z329eNZzTYw1nXM&download=image.png "")

![](https://tcs.teambition.net/storage/312237909312495e54fbf5c40a82e7b98da9?Signature=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJBcHBJRCI6IjU5Mzc3MGZmODM5NjMyMDAyZTAzNThmMSIsIl9hcHBJZCI6IjU5Mzc3MGZmODM5NjMyMDAyZTAzNThmMSIsIl9vcmdhbml6YXRpb25JZCI6IiIsImV4cCI6MTYxMjc5NTEwNywiaWF0IjoxNjEyMTkwMzA3LCJyZXNvdXJjZSI6Ii9zdG9yYWdlLzMxMjIzNzkwOTMxMjQ5NWU1NGZiZjVjNDBhODJlN2I5OGRhOSJ9.cNrwwBTBKJTW3Nm-TeWNfsXoT9NUYu7XZdclA4CiR10&download=image.png "")

![](https://tcs.teambition.net/storage/3122b577b073b8e148479463b559eef08388?Signature=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJBcHBJRCI6IjU5Mzc3MGZmODM5NjMyMDAyZTAzNThmMSIsIl9hcHBJZCI6IjU5Mzc3MGZmODM5NjMyMDAyZTAzNThmMSIsIl9vcmdhbml6YXRpb25JZCI6IiIsImV4cCI6MTYxMjc5NTEwNywiaWF0IjoxNjEyMTkwMzA3LCJyZXNvdXJjZSI6Ii9zdG9yYWdlLzMxMjJiNTc3YjA3M2I4ZTE0ODQ3OTQ2M2I1NTllZWYwODM4OCJ9.8XtfZdQtZ3CRgObxV3oi0ACzBKbZt4YYE20amWWpNCU&download=image.png "")

![](https://tcs.teambition.net/storage/3122e46e6c2ad8fe84edfef4c6afb5483d7b?Signature=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJBcHBJRCI6IjU5Mzc3MGZmODM5NjMyMDAyZTAzNThmMSIsIl9hcHBJZCI6IjU5Mzc3MGZmODM5NjMyMDAyZTAzNThmMSIsIl9vcmdhbml6YXRpb25JZCI6IiIsImV4cCI6MTYxMjc5NTEwNywiaWF0IjoxNjEyMTkwMzA3LCJyZXNvdXJjZSI6Ii9zdG9yYWdlLzMxMjJlNDZlNmMyYWQ4ZmU4NGVkZmVmNGM2YWZiNTQ4M2Q3YiJ9.Lj_Ab99SczwXvVxJNDNCheXAHgBqxC1YD7m_nMQwxs0&download=image.png "")

![](https://tcs.teambition.net/storage/312248ef73c6cbd0673c62bb96e95eb7835f?Signature=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJBcHBJRCI6IjU5Mzc3MGZmODM5NjMyMDAyZTAzNThmMSIsIl9hcHBJZCI6IjU5Mzc3MGZmODM5NjMyMDAyZTAzNThmMSIsIl9vcmdhbml6YXRpb25JZCI6IiIsImV4cCI6MTYxMjc5NTEwNywiaWF0IjoxNjEyMTkwMzA3LCJyZXNvdXJjZSI6Ii9zdG9yYWdlLzMxMjI0OGVmNzNjNmNiZDA2NzNjNjJiYjk2ZTk1ZWI3ODM1ZiJ9.cflvZEIEPtP7bUG7jOOLt5TuMkwS8n6jNGrmEBEv7sA&download=image.png "")

[https://www.rabbitmq.com/community-plugins.html](https://www.rabbitmq.com/community-plugins.html)

![](https://tcs.teambition.net/storage/3122310ee5d72dcfc04fe4fe2bc77e1de7dc?Signature=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJBcHBJRCI6IjU5Mzc3MGZmODM5NjMyMDAyZTAzNThmMSIsIl9hcHBJZCI6IjU5Mzc3MGZmODM5NjMyMDAyZTAzNThmMSIsIl9vcmdhbml6YXRpb25JZCI6IiIsImV4cCI6MTYxMjc5NTEwNywiaWF0IjoxNjEyMTkwMzA3LCJyZXNvdXJjZSI6Ii9zdG9yYWdlLzMxMjIzMTBlZTVkNzJkY2ZjMDRmZTRmZTJiYzc3ZTFkZTdkYyJ9.N2EUAOwdFBo6jlwRBFkX6VDmb2395-1bmnX-Dkd_Ayc&download=image.png "")

![](https://tcs.teambition.net/storage/31221d0a2814a4593fcaeba9f4045ab81096?Signature=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJBcHBJRCI6IjU5Mzc3MGZmODM5NjMyMDAyZTAzNThmMSIsIl9hcHBJZCI6IjU5Mzc3MGZmODM5NjMyMDAyZTAzNThmMSIsIl9vcmdhbml6YXRpb25JZCI6IiIsImV4cCI6MTYxMjc5NTEwNywiaWF0IjoxNjEyMTkwMzA3LCJyZXNvdXJjZSI6Ii9zdG9yYWdlLzMxMjIxZDBhMjgxNGE0NTkzZmNhZWJhOWY0MDQ1YWI4MTA5NiJ9.RMd6fSbCRGOsBgeY2xeO8NH7bET5vJTJW1kk0c3At5I&download=image.png "")

```java
package com.imooc.springcloud.topic;

import org.springframework.cloud.stream.annotation.Input;
import org.springframework.cloud.stream.annotation.Output;
import org.springframework.messaging.MessageChannel;
import org.springframework.messaging.SubscribableChannel;

/**
 * input 指的是接收消息的那一端
 * 也就是消费者
 * output 指生产消息的那一端
 * 也就是生产者
 */
public interface DelayedTopic {

    /**
     * 把两个 信道绑定在一起
     */
    String INPUT = "delayed-consumer";

    String OUTPUT = "delayed-producer";

    // topic的名称
    @Input(INPUT)
    SubscribableChannel input();

    /**
     * INPUT 会当成一个 Bean 的 name
     * 相当于声明了 2 个 Bean 都有同样的 name Spring 启动的时候就会报错
     */
    @Output(OUTPUT)
    MessageChannel output();

}

```

![](https://tcs.teambition.net/storage/31227202a95df071cf8a52e373dae918596c?Signature=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJBcHBJRCI6IjU5Mzc3MGZmODM5NjMyMDAyZTAzNThmMSIsIl9hcHBJZCI6IjU5Mzc3MGZmODM5NjMyMDAyZTAzNThmMSIsIl9vcmdhbml6YXRpb25JZCI6IiIsImV4cCI6MTYxMjc5NTEwNywiaWF0IjoxNjEyMTkwMzA3LCJyZXNvdXJjZSI6Ii9zdG9yYWdlLzMxMjI3MjAyYTk1ZGYwNzFjZjhhNTJlMzczZGFlOTE4NTk2YyJ9.Ymp5E0vb7Z2m3rMQUDpwrCqQ5hwaW-Qpo4ON5zL-v5Q&download=image.png "")

```java
package com.imooc.springcloud.biz;

import com.imooc.springcloud.topic.DelayedTopic;
import com.imooc.springcloud.topic.GroupTopic;
import com.imooc.springcloud.topic.MyTopic;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.messaging.support.MessageBuilder;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;

@RestController
@Slf4j
public class Controller {

    @Autowired
    private MyTopic producer;

    @Autowired
    private GroupTopic groupTopicProducer;

    @Autowired
    private DelayedTopic delayedTopicProducer;


    @PostMapping("send")
    public void sendMessage(@RequestParam(value = "body") String body) {
        producer.output().send(MessageBuilder.withPayload(body).build());
    }

    @PostMapping("sendToGroup")
    public void sendMessageToGroup(@RequestParam(value = "body") String body) {
        groupTopicProducer.output().send(MessageBuilder.withPayload(body).build());
    }

    @PostMapping("sendDM")
    public void sendDelayedMessage(@RequestParam(value = "body") String body,
                                   @RequestParam(value = "seconds") Integer seconds) {
        MessageBean msg = new MessageBean();
        msg.setPayload(body);
        log.info("ready to send delayed message");
        delayedTopicProducer.output().send(
                MessageBuilder.withPayload(msg)
                        /**
                         * x-delay 延迟消息就会把它延迟多少秒之后 送达到消费者这里
                         */
                        .setHeader("x-delay",1000 * seconds)
                        .build());
    }







}


```

![](https://tcs.teambition.net/storage/312203cabcc8fe5cc13c8f082482dd03051a?Signature=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJBcHBJRCI6IjU5Mzc3MGZmODM5NjMyMDAyZTAzNThmMSIsIl9hcHBJZCI6IjU5Mzc3MGZmODM5NjMyMDAyZTAzNThmMSIsIl9vcmdhbml6YXRpb25JZCI6IiIsImV4cCI6MTYxMjc5NTEwNywiaWF0IjoxNjEyMTkwMzA3LCJyZXNvdXJjZSI6Ii9zdG9yYWdlLzMxMjIwM2NhYmNjOGZlNWNjMTNjOGYwODI0ODJkZDAzMDUxYSJ9.aPuc0u-it3iIc11FdxFMtzuZ5BoVE3l17FxQi2jPlNo&download=image.png "")

```java
package com.imooc.springcloud.biz;

import com.imooc.springcloud.topic.DelayedTopic;
import com.imooc.springcloud.topic.GroupTopic;
import com.imooc.springcloud.topic.MyTopic;
import lombok.extern.slf4j.Slf4j;
import org.springframework.cloud.stream.annotation.EnableBinding;
import org.springframework.cloud.stream.annotation.StreamListener;
import org.springframework.cloud.stream.messaging.Sink;

@Slf4j
/**
 * 启动绑定信道
 * 就是说 Binder与中间件之间绑定的信道接口 接口可以理解为规定好的行为类型的地址
 */
@EnableBinding(value = {

        /**
         * value 可以绑定信道名称
         * Stream 的上下文就会把这个类当做一个可绑定的信道
         * 加入进初始化流程当中
         * 信道跟Topic（主题） 类似的功能 可以看成同一种概念
         * MyTopic.class 通过这种方式我们可以自定义一个信道，将
         * 自定义的主题绑定到EnableBinding注解的下面，这样我们就可以通过Controller触发生产者消息发送，
         * 然后在看消费者是如何消费这个消息的
         * 并且把它加入到上下文当中
         *
         */
        Sink.class,
        MyTopic.class,
        GroupTopic.class,
        DelayedTopic.class
    }
)
public class StreamConsumer {

    /**
     * 怎么知道 该去rabbitmq 拿那个消息信道中的消息呢？给它指示
     * 传入一个信道的名称
     * sink 它是messaging 给我们提供的一个默认信道
     * @Input("input") 会自动为我们创建一个
     * SubscribableChannel 一个可被订阅的 channel通信通道
     * 通道的名称就是 Sink.INPUT  指定的值 默认为input
     * @StreamListener 将信道绑定到当前的这个方法上 和 RabbitMQ中的主题进行关联
     * 我们的方法体也就能够监听这个信道生成的消息去进行消费
     * 默认目的地信道接口 Sink 翻译为目的地
     * 被注解之后通道与这个类通过反射绑定起来 从应用程序绑定到一起 多个
     * 当binder与消息中间件通信 发送消息过来 通过反射实例化对象执行这些方法
     *
     */
    @StreamListener(Sink.INPUT) // 这里的值就是 "input"
    public void consume(Object payload) {

        log.info("message consumed successfully，payload={}", payload);
    }
    @StreamListener(MyTopic.INPUT)
    public void consumeMyMessage(Object payload) {

        log.info("My message consumed successfully，payload={}", payload);
    }

    @StreamListener(GroupTopic.INPUT)
    public void consumeGroupMyMessage(Object payload) {
        log.info("Group message consumed successfully，payload={}", payload);
    }

    @StreamListener(DelayedTopic.INPUT)
    public void consumeDelayedMessage(MessageBean bean) {
        log.info("Delayed message consumed successfully，payload={}", bean.getPayload());
    }


}

```

![](https://tcs.teambition.net/storage/3122e56d06847d969402260acd0958d85e80?Signature=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJBcHBJRCI6IjU5Mzc3MGZmODM5NjMyMDAyZTAzNThmMSIsIl9hcHBJZCI6IjU5Mzc3MGZmODM5NjMyMDAyZTAzNThmMSIsIl9vcmdhbml6YXRpb25JZCI6IiIsImV4cCI6MTYxMjc5NTEwNywiaWF0IjoxNjEyMTkwMzA3LCJyZXNvdXJjZSI6Ii9zdG9yYWdlLzMxMjJlNTZkMDY4NDdkOTY5NDAyMjYwYWNkMDk1OGQ4NWU4MCJ9.xwpGdqNonJDC1VY8-sw1ogEHncpbIy-OAav4wNzsT-Q&download=image.png "")

```text
spring.application.name=stream-sample
#server.port=63001
#server.port=63000
server.port=63002

# RabbitMQ连接字符串
spring.rabbitmq.host=localhost
spring.rabbitmq.port=5672
spring.rabbitmq.username=guest
spring.rabbitmq.password=guest

# 把两个不同名称的信道 绑定 在一起 重定向到 目的地 一个真正的 Topic
# 不同的信道 绑定到相同的 Topic当中 当生产者发送消息 到指定的 Topic 消费者就可以消费
# 绑定Channel到broadcast
spring.cloud.stream.bindings.myTopic-consumer.destination=broadcast
spring.cloud.stream.bindings.myTopic-producer.destination=broadcast

# 消息分组示例
spring.cloud.stream.bindings.group-consumer.destination=group-topic
spring.cloud.stream.bindings.group-producer.destination=group-topic
# 消息分组是对与消费者来说 划分到组A当中
spring.cloud.stream.bindings.group-consumer.group=Group-A

# 延迟消息配置
spring.cloud.stream.bindings.delayed-consumer.destination=delayed-topic
spring.cloud.stream.bindings.delayed-producer.destination=delayed-topic

# 声明 Queue exchange 类型 创建延迟队列
spring.cloud.stream.rabbit.bindings.delayed-producer.producer.delayed-exchange=true

# 消费分区配置
# 消费分区最终会落实在consumer里 所以要把consumer的消费分区功能打开
# 打开消费者的消费分区功能
spring.cloud.stream.bindings.group-consumer.consumer.partitioned=true

# 使用生产者来配置消费分区数量
# 两个消费分区
spring.cloud.stream.bindings.group-producer.producer.partition-count=2

# 如何识别消费分区
# SpEL表达式（Key resolver）
# 只有索引参数为1的节点（消费者），才能消费消息
# 通过生产者的 key expression配置 只有参数为1的节点消费者才能接收到数据
spring.cloud.stream.bindings.group-producer.producer.partition-key-expression=1

# 当前消费者实例总数
spring.cloud.stream.instanceCount=2

# 索引参数 跟上面搭配使用 最大值是 instanceCount-1
# 表示当前实例的索引号
#spring.cloud.stream.instanceIndex=0
spring.cloud.stream.instanceIndex=1

management.endpoints.web.exposure.include=*
management.endpoint.health.show-details=always
```

启动

![](https://tcs.teambition.net/storage/31227f45df3fd9d5ecd6a3ccc3e1c27d19ef?Signature=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJBcHBJRCI6IjU5Mzc3MGZmODM5NjMyMDAyZTAzNThmMSIsIl9hcHBJZCI6IjU5Mzc3MGZmODM5NjMyMDAyZTAzNThmMSIsIl9vcmdhbml6YXRpb25JZCI6IiIsImV4cCI6MTYxMjc5NTEwNywiaWF0IjoxNjEyMTkwMzA3LCJyZXNvdXJjZSI6Ii9zdG9yYWdlLzMxMjI3ZjQ1ZGYzZmQ5ZDVlY2Q2YTNjY2MzZTFjMjdkMTllZiJ9.6Gjztn9nOoa9oORyhx_bF9THBN6lJAmxzgCHl8jaei0&download=image.png "")

![](https://tcs.teambition.net/storage/3122eef61f9e711d77e2561fe9b5fd60e10a?Signature=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJBcHBJRCI6IjU5Mzc3MGZmODM5NjMyMDAyZTAzNThmMSIsIl9hcHBJZCI6IjU5Mzc3MGZmODM5NjMyMDAyZTAzNThmMSIsIl9vcmdhbml6YXRpb25JZCI6IiIsImV4cCI6MTYxMjc5NTEwNywiaWF0IjoxNjEyMTkwMzA3LCJyZXNvdXJjZSI6Ii9zdG9yYWdlLzMxMjJlZWY2MWY5ZTcxMWQ3N2UyNTYxZmU5YjVmZDYwZTEwYSJ9.iBmyrO1qSi_X47OPa6UFrHBQi_kI0wSVLiVy7wgyNPs&download=image.png "")

x-delayed-message 延迟消息信道类型

![](https://tcs.teambition.net/storage/3122733a5e37fbe8f84664bd2d164b12401a?Signature=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJBcHBJRCI6IjU5Mzc3MGZmODM5NjMyMDAyZTAzNThmMSIsIl9hcHBJZCI6IjU5Mzc3MGZmODM5NjMyMDAyZTAzNThmMSIsIl9vcmdhbml6YXRpb25JZCI6IiIsImV4cCI6MTYxMjc5NTEwNywiaWF0IjoxNjEyMTkwMzA3LCJyZXNvdXJjZSI6Ii9zdG9yYWdlLzMxMjI3MzNhNWUzN2ZiZThmODQ2NjRiZDJkMTY0YjEyNDAxYSJ9.tIO7OkllRPD2spZlVbwoOIyvSSoTDH-zxkUVUA1XUpQ&download=image.png "")

 messages delayed:	0

目前在Queue的所有message数量

![](https://tcs.teambition.net/storage/312246f3a836747c7f8f68bf5ffa477bbd13?Signature=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJBcHBJRCI6IjU5Mzc3MGZmODM5NjMyMDAyZTAzNThmMSIsIl9hcHBJZCI6IjU5Mzc3MGZmODM5NjMyMDAyZTAzNThmMSIsIl9vcmdhbml6YXRpb25JZCI6IiIsImV4cCI6MTYxMjc5NTEwNywiaWF0IjoxNjEyMTkwMzA3LCJyZXNvdXJjZSI6Ii9zdG9yYWdlLzMxMjI0NmYzYTgzNjc0N2M3ZjhmNjhiZjVmZmE0NzdiYmQxMyJ9.R71rLIln-EFxoMb8MmYFAUj_kyJrNbkn4HqlrvI6Pmo&download=image.png "")

![](https://tcs.teambition.net/storage/3122ec1b4708b65b4d76fee8b918bebea4aa?Signature=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJBcHBJRCI6IjU5Mzc3MGZmODM5NjMyMDAyZTAzNThmMSIsIl9hcHBJZCI6IjU5Mzc3MGZmODM5NjMyMDAyZTAzNThmMSIsIl9vcmdhbml6YXRpb25JZCI6IiIsImV4cCI6MTYxMjc5NTEwNywiaWF0IjoxNjEyMTkwMzA3LCJyZXNvdXJjZSI6Ii9zdG9yYWdlLzMxMjJlYzFiNDcwOGI2NWI0ZDc2ZmVlOGI5MThiZWJlYTRhYSJ9.uXYPERmYrNOvQ6u3feHI3__X68LvXQ3pRb00V3fBaqQ&download=image.png "")

```text
2021-01-31 13:38:19.563  INFO 79189 --- [io-63002-exec-4] com.imooc.springcloud.biz.Controller     : ready to send delayed message
2021-01-31 13:38:24.569  INFO 79189 --- [q-WWwjydjGmYw-1] c.imooc.springcloud.biz.StreamConsumer   : Delayed message consumed successfully，payload=test


```







开源笔记

可 Pull Requests 协作写开源笔记

如果笔记图片无法访问 请访问 [teambition](https://tburl.in/0jDNvpbK) 原版开源笔记

gitee

[https://gitee.com/opendevel/java-for-linux](https://gitee.com/opendevel/java-for-linux)

github

[https://github.com/OSrcD/java-for-linux](https://github.com/OSrcD/java-for-linux)

teambition

[https://tburl.in/0jDNvpbK](https://tburl.in/0jDNvpbK)

开源视频

bilibili

[https://space.bilibili.com/77266754](https://space.bilibili.com/77266754)

开源博客

oschina

[https://my.oschina.net/u/4675154](https://my.oschina.net/u/4675154)

csdn

[https://blog.csdn.net/OpenDevel](https://blog.csdn.net/OpenDevel)

开源项目

gitee

[https://gitee.com/opendevel](https://gitee.com/opendevel)

github

[https://github.com/OSrcD](https://github.com/OSrcD)

开源赞赏

![](https://tcs.teambition.net/storage/3121aed56e96d914e1046f3b498b493ce232?Signature=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJBcHBJRCI6IjU5Mzc3MGZmODM5NjMyMDAyZTAzNThmMSIsIl9hcHBJZCI6IjU5Mzc3MGZmODM5NjMyMDAyZTAzNThmMSIsIl9vcmdhbml6YXRpb25JZCI6IiIsImV4cCI6MTYxMjc5NTEwNywiaWF0IjoxNjEyMTkwMzA3LCJyZXNvdXJjZSI6Ii9zdG9yYWdlLzMxMjFhZWQ1NmU5NmQ5MTRlMTA0NmYzYjQ5OGI0OTNjZTIzMiJ9.ELeiwQldNkE-SMe_32HjifoGhcZtMovniek6UEWwuPE&download=image.png "")

